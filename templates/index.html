<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>별이삼샵 캐릭터 채팅</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; margin: 0; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; }
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { padding: 10px 15px; border-radius: 18px; max-width: 70%; line-height: 1.5; font-size: 14px; }
        .user { align-self: flex-end; background: #fee500; color: #3c1e1e; border-bottom-right-radius: 2px; }
        .bot { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        #input-area { padding: 15px; background: white; display: flex; gap: 10px; border-top: 1px solid #ddd; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 25px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div id="chat-window"></div>
    <div id="input-area">
        <input type="text" id="msg-input" placeholder="메시지를 입력하세요..." onkeypress="if(event.keyCode==13) sendMessage()">
        <button onclick="sendMessage()">전송</button>
    </div>

    <script>
        const roomId = window.location.pathname.split('/').pop();

        async function loadMessages() {
            try {
                const res = await fetch(`http://127.0.0.1:8000/api/chat/rooms/${roomId}/messages`);
                const data = await res.json();
                const win = document.getElementById('chat-window');
                win.innerHTML = '';
                data.forEach(m => {
                    const div = document.createElement('div');
                    div.className = `msg ${m.sender}`;
                    div.innerText = m.content;
                    win.appendChild(div);
                });
                win.scrollTop = win.scrollHeight;
            } catch (e) { console.error("메시지 로딩 실패:", e); }
        }

        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const content = input.value;
            if(!content) return;

            input.value = '';
            
            try {
                await fetch(`http://127.0.0.1:8000/api/chat/rooms/${roomId}/messages`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ content: content, sender: 'user' })
                });
                loadMessages(); // 전송 후 목록 새로고침
            } catch (e) { alert("전송 실패!"); }
        }

        // 페이지 열리면 기존 메시지 불러오기
        loadMessages();
        // 3초마다 새 메시지 있는지 확인 (폴링)
        setInterval(loadMessages, 3000);
    </script>
</body>
</html>